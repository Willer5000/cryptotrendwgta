<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wgta Crypto Trading Signals</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0E1117;
            --bg-secondary: #161B26;
            --bg-card: #1A1F2C;
            --text-primary: #FFFFFF;
            --text-secondary: #A0AEC0;
            --accent-green: #4CAF50;
            --accent-red: #F44336;
            --accent-blue: #2196F3;
            --accent-yellow: #FFEB3B;
            --accent-purple: #9C27B0;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            background-color: var(--bg-card);
            border: 1px solid #2D3748;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            background: linear-gradient(45deg, var(--bg-secondary), var(--bg-card));
            border-bottom: 1px solid #2D3748;
            font-weight: 600;
        }
        
        .signal-card { 
            transition: transform 0.3s, box-shadow 0.3s; 
            border-left: 4px solid transparent;
        }
        
        .signal-card.long { border-left-color: var(--accent-green); }
        .signal-card.short { border-left-color: var(--accent-red); }
        
        .signal-card:hover { 
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .table {
            color: var(--text-primary);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .badge-long { 
            background-color: var(--accent-green);
            color: white;
        }
        
        .badge-short { 
            background-color: var(--accent-red);
            color: white;
        }
        
        .filter-section {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        
        .form-control, .form-select {
            background-color: var(--bg-card);
            border: 1px solid #2D3748;
            color: var(--text-primary);
        }
        
        .form-control:focus, .form-select:focus {
            background-color: var(--bg-card);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
            color: var(--text-primary);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--accent-blue), #1976D2);
            border: none;
            font-weight: 500;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #1976D2, #1565C0);
            transform: translateY(-1px);
        }
        
        .progress {
            background-color: #2D3748;
            height: 10px;
        }
        
        .progress-bar {
            background: linear-gradient(45deg, var(--accent-blue), #1976D2);
        }
        
        .volume-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .volume-muy-alto { background-color: var(--accent-green); color: white; }
        .volume-alto { background-color: var(--accent-blue); color: white; }
        .volume-medio { background-color: var(--accent-yellow); color: black; }
        .volume-bajo { background-color: #FF9800; color: white; }
        .volume-muy-bajo { background-color: var(--accent-red); color: white; }
        
        .scatter-chart-container {
            height: 600px;
            background-color: var(--bg-card);
            border-radius: 8px;
            padding: 15px;
        }
        
        .timeframe-selector {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .timeframe-btn {
            padding: 5px 10px;
            border-radius: 6px;
            background-color: var(--bg-secondary);
            border: 1px solid #2D3748;
            color: var(--text-secondary);
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .timeframe-btn.active {
            background: linear-gradient(45deg, var(--accent-blue), #1976D2);
            color: white;
            border-color: var(--accent-blue);
        }
        
        .timeframe-btn:hover:not(.active) {
            background-color: #2D3748;
            color: var(--text-primary);
        }
        
        .market-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(45deg, var(--bg-secondary), var(--bg-card));
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .stat-long { color: var(--accent-green); }
        .stat-short { color: var(--accent-red); }
        .stat-neutral { color: var(--accent-blue); }
        
        @media (max-width: 768px) {
            .market-stats {
                grid-template-columns: 1fr;
            }
            
            .timeframe-selector {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <header class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom border-secondary">
            <div>
                <h1 class="h3 mb-1"><i class="fas fa-chart-line me-2"></i> wgta Crypto Trading Signals</h1>
                <p class="text-secondary mb-0">Sistema avanzado de detección de oportunidades de trading</p>
                <p class="text-secondary small mb-0">
                    <i class="fas fa-sync-alt me-1"></i> Última actualización: {{ last_update.strftime('%Y-%m-%d %H:%M:%S') }}
                    <span class="badge {{ 'bg-warning' if is_updating else 'bg-success' }} ms-2">
                        {{ 'Actualizando...' if is_updating else 'Datos listos' }}
                    </span>
                </p>
                
                {% if is_updating %}
                <div class="mt-2">
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: {{ update_progress }}%;" 
                             aria-valuenow="{{ update_progress }}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                        </div>
                    </div>
                    <small class="text-secondary">Progreso: {{ update_progress }}%</small>
                </div>
                {% endif %}
            </div>
            <div class="text-end">
                <p class="mb-1 text-secondary">Autor: wgta</p>
                <div class="d-flex gap-2 justify-content-end">
                    <a href="https://github.com/Willer5000" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="fab fa-github"></i> GitHub
                    </a>
                    <a href="/manual" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-book"></i> Manual
                    </a>
                </div>
            </div>
        </header>

        <!-- Selector de Timeframes -->
        <div class="timeframe-selector">
            {% for tf in ['15m', '30m', '1h', '2h', '4h', '1d', '1w'] %}
            <button class="timeframe-btn {{ 'active' if params.timeframe == tf }}" 
                    onclick="changeTimeframe('{{ tf }}')">
                {{ tf }}
            </button>
            {% endfor %}
        </div>

        <!-- Estadísticas del Mercado -->
        <div class="market-stats">
            <div class="stat-card">
                <div class="text-secondary">Criptomonedas</div>
                <div class="stat-value stat-neutral">{{ cryptos_analyzed }}</div>
                <small>Analizadas</small>
            </div>
            <div class="stat-card">
                <div class="text-secondary">Señales LONG</div>
                <div class="stat-value stat-long">{{ long_signals|length }}</div>
                <small>ADX Prom: {{ avg_adx_long }}</small>
            </div>
            <div class="stat-card">
                <div class="text-secondary">Señales SHORT</div>
                <div class="stat-value stat-short">{{ short_signals|length }}</div>
                <small>ADX Prom: {{ avg_adx_short }}</small>
            </div>
            <div class="stat-card">
                <div class="text-secondary">Señales Históricas</div>
                <div class="stat-value stat-neutral">{{ historical_signals|length }}</div>
                <small>Vela anterior</small>
            </div>
        </div>

        <!-- Información del Sistema -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-info-circle me-2"></i> Información del Sistema</span>
                <span class="badge bg-primary">{{ params.timeframe }}</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Zona horaria:</strong> Nueva York (UTC-4/5)</p>
                        <p class="mb-1"><strong>Actualización automática:</strong> Cada 5 minutos</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>EMA Rápida/Lenta:</strong> {{ params.ema_fast }}/{{ params.ema_slow }}</p>
                        <p class="mb-0"><strong>ADX Periodo/Nivel:</strong> {{ params.adx_period }}/{{ params.adx_level }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección de Filtros -->
        <div class="filter-section">
            <h5 class="mb-3"><i class="fas fa-filter me-2"></i> Parámetros de Análisis</h5>
            <form id="filters-form" method="POST" action="/update_params">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">EMA Rápida</label>
                        <input type="number" name="ema_fast" value="{{ params.ema_fast }}" class="form-control" min="1" max="50">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">EMA Lenta</label>
                        <input type="number" name="ema_slow" value="{{ params.ema_slow }}" class="form-control" min="1" max="100">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">ADX Período</label>
                        <input type="number" name="adx_period" value="{{ params.adx_period }}" class="form-control" min="1" max="50">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">ADX Nivel</label>
                        <input type="number" name="adx_level" value="{{ params.adx_level }}" class="form-control" min="1" max="100" step="0.1">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">RSI Período</label>
                        <input type="number" name="rsi_period" value="{{ params.rsi_period }}" class="form-control" min="1" max="50">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">S/R Ventana</label>
                        <input type="number" name="sr_window" value="{{ params.sr_window }}" class="form-control" min="10" max="200">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Divergencia Lookback</label>
                        <input type="number" name="divergence_lookback" value="{{ params.divergence_lookback }}" class="form-control" min="5" max="50">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">ATR Período</label>
                        <input type="number" name="atr_period" value="{{ params.atr_period }}" class="form-control" min="5" max="50">
                    </div>
                    
                    <div class="col-md-12 mt-4">
                        <button type="submit" class="btn btn-primary w-100 py-2">
                            <i class="fas fa-sync-alt me-2"></i> Actualizar Parámetros y Recargar Datos
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Gráfico de Dispersión -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-scatter me-2"></i> Probabilidades de Trading</h5>
                <div>
                    <select id="volume-filter" class="form-select form-select-sm" style="width: 150px;">
                        <option value="all">Todos los volúmenes</option>
                        <option value="Muy Alto">Muy Alto</option>
                        <option value="Alto">Alto</option>
                        <option value="Medio">Medio</option>
                        <option value="Bajo">Bajo</option>
                        <option value="Muy Bajo">Muy Bajo</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div id="scatterPlot" class="scatter-chart-container"></div>
            </div>
        </div>

        <!-- Señales Históricas -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i> Señales Históricas (Vela Anterior)</h5>
                <small class="text-secondary">Señales que se generaron en la vela anterior del timeframe actual</small>
            </div>
            <div class="card-body">
                {% if historical_signals %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Símbolo</th>
                                <th>Dirección</th>
                                <th>Volumen</th>
                                <th>Entrada</th>
                                <th>SL</th>
                                <th>TP1</th>
                                <th>TP2</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for signal in historical_signals %}
                            <tr class="signal-card {{ 'long' if signal.type == 'LONG' else 'short' }}">
                                <td>{{ loop.index }}</td>
                                <td>{{ signal.symbol }}</td>
                                <td>
                                    <span class="badge {{ 'badge-long' if signal.type == 'LONG' else 'badge-short' }}">
                                        {{ signal.type }}
                                    </span>
                                </td>
                                <td>
                                    <span class="volume-badge volume-{{ signal.volume|lower|replace(' ', '-') }}">
                                        {{ signal.volume }}
                                    </span>
                                </td>
                                <td>{{ signal.entry }}</td>
                                <td class="text-danger">{{ signal.sl }}</td>
                                <td class="text-success">{{ signal.tp1 }}</td>
                                <td class="text-success">{{ signal.tp2 }}</td>
                                <td>
                                    <a href="/historical_chart/{{ signal.symbol }}/{{ signal.type|lower }}" 
                                       class="btn btn-sm btn-info">
                                        <i class="fas fa-chart-line"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No hay señales históricas para la vela anterior.
                </div>
                {% endif %}
            </div>
        </div>

        <div class="row">
            <!-- Señales LONG -->
            <div class="col-lg-6">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-arrow-up me-2"></i> Señales LONG ({{ long_signals|length }})</h5>
                        <span class="badge badge-long">ADX: {{ avg_adx_long }}</span>
                    </div>
                    <div class="card-body">
                        {% if long_signals %}
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Símbolo</th>
                                        <th>Precio</th>
                                        <th>Entrada</th>
                                        <th>Dist</th>
                                        <th>SL</th>
                                        <th>TP1</th>
                                        <th>TP2</th>
                                        <th>Vol</th>
                                        <th>ADX</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for signal in long_signals %}
                                    <tr class="signal-card long">
                                        <td>{{ loop.index }}</td>
                                        <td>{{ signal.symbol }}</td>
                                        <td>{{ signal.price }}</td>
                                        <td>{{ signal.entry }}</td>
                                        <td>{{ signal.distance }}%</td>
                                        <td class="text-danger">{{ signal.sl }}</td>
                                        <td class="text-success">{{ signal.tp1 }}</td>
                                        <td class="text-success">{{ signal.tp2 }}</td>
                                        <td>
                                            <span class="volume-badge volume-{{ signal.volume|lower|replace(' ', '-') }}">
                                                {{ signal.volume }}
                                            </span>
                                        </td>
                                        <td>{{ signal.adx }}</td>
                                        <td>
                                            <a href="/chart/{{ signal.symbol }}/long" class="btn btn-sm btn-info">
                                                <i class="fas fa-chart-line"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No hay señales LONG en este momento.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Señales SHORT -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-arrow-down me-2"></i> Señales SHORT ({{ short_signals|length }})</h5>
                        <span class="badge badge-short">ADX: {{ avg_adx_short }}</span>
                    </div>
                    <div class="card-body">
                        {% if short_signals %}
                        <div class="table-responsive" style="max-height: 500px;">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Símbolo</th>
                                        <th>Precio</th>
                                        <th>Entrada</th>
                                        <th>Dist</th>
                                        <th>SL</th>
                                        <th>TP1</th>
                                        <th>TP2</th>
                                        <th>Vol</th>
                                        <th>ADX</th>
                                        <th>Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for signal in short_signals %}
                                    <tr class="signal-card short">
                                        <td>{{ loop.index }}</td>
                                        <td>{{ signal.symbol }}</td>
                                        <td>{{ signal.price }}</td>
                                        <td>{{ signal.entry }}</td>
                                        <td>{{ signal.distance }}%</td>
                                        <td class="text-danger">{{ signal.sl }}</td>
                                        <td class="text-success">{{ signal.tp1 }}</td>
                                        <td class="text-success">{{ signal.tp2 }}</td>
                                        <td>
                                            <span class="volume-badge volume-{{ signal.volume|lower|replace(' ', '-') }}">
                                                {{ signal.volume }}
                                            </span>
                                        </td>
                                        <td>{{ signal.adx }}</td>
                                        <td>
                                            <a href="/chart/{{ signal.symbol }}/short" class="btn btn-sm btn-info">
                                                <i class="fas fa-chart-line"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No hay señales SHORT en este momento.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Cambiar timeframe
        function changeTimeframe(timeframe) {
            const form = document.getElementById('filters-form');
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'timeframe';
            hiddenInput.value = timeframe;
            form.appendChild(hiddenInput);
            form.submit();
        }
        
        // Gráfico de dispersión
        const scatterData = {{ scatter_data|tojson }};
        const volumeColors = {
            'Muy Alto': '#4CAF50',
            'Alto': '#2196F3', 
            'Medio': '#FFEB3B',
            'Bajo': '#FF9800',
            'Muy Bajo': '#F44336'
        };
        
        const traces = [];
        const volumes = ['Muy Alto', 'Alto', 'Medio', 'Bajo', 'Muy Bajo'];
        
        volumes.forEach(vol => {
            const filteredData = scatterData.filter(item => item.volume === vol);
            if (filteredData.length > 0) {
                traces.push({
                    x: filteredData.map(d => d.long_prob),
                    y: filteredData.map(d => d.short_prob),
                    text: filteredData.map(d => d.symbol),
                    mode: 'markers',
                    type: 'scatter',
                    name: vol,
                    marker: {
                        size: 8,
                        color: volumeColors[vol],
                        opacity: 0.8
                    },
                    hovertemplate: '<b>%{text}</b><br>LONG: %{x}%<br>SHORT: %{y}%<extra></extra>'
                });
            }
        });
        
        // Destacar Bitcoin
        const btcData = scatterData.find(d => d.symbol === 'BTC');
        if (btcData) {
            traces.push({
                x: [btcData.long_prob],
                y: [btcData.short_prob],
                text: ['BTC'],
                mode: 'markers+text',
                type: 'scatter',
                name: 'Bitcoin',
                marker: {
                    size: 12,
                    color: '#FFD700',
                    symbol: 'star'
                },
                textfont: {
                    size: 12,
                    color: '#FFD700'
                },
                hovertemplate: '<b>BTC</b><br>LONG: %{x}%<br>SHORT: %{y}%<extra></extra>'
            });
        }
        
        const layout = {
            title: {
                text: `Probabilidades de Trading - ${scatterData.length} Criptomonedas`,
                font: { color: '#FFFFFF' }
            },
            xaxis: {
                title: { text: 'Probabilidad LONG (%)', font: { color: '#FFFFFF' } },
                range: [0, 100],
                gridcolor: 'rgba(255, 255, 255, 0.1)',
                zerolinecolor: 'rgba(255, 255, 255, 0.3)',
                color: '#FFFFFF'
            },
            yaxis: {
                title: { text: 'Probabilidad SHORT (%)', font: { color: '#FFFFFF' } },
                range: [0, 100],
                gridcolor: 'rgba(255, 255, 255, 0.1)',
                zerolinecolor: 'rgba(255, 255, 255, 0.3)',
                color: '#FFFFFF'
            },
            plot_bgcolor: 'rgba(0, 0, 0, 0)',
            paper_bgcolor: 'rgba(0, 0, 0, 0)',
            font: { color: '#FFFFFF' },
            legend: {
                orientation: 'h',
                y: -0.2,
                font: { color: '#FFFFFF' }
            },
            shapes: [
                {
                    type: 'rect', x0: 66.6, x1: 100, y0: 0, y1: 33.3,
                    fillcolor: 'rgba(76, 175, 80, 0.1)', line: { width: 0 }
                },
                {
                    type: 'rect', x0: 33.3, x1: 66.6, y0: 0, y1: 33.3,
                    fillcolor: 'rgba(76, 175, 80, 0.05)', line: { width: 0 }
                },
                {
                    type: 'rect', x0: 0, x1: 33.3, y0: 66.6, y1: 100,
                    fillcolor: 'rgba(244, 67, 54, 0.1)', line: { width: 0 }
                },
                {
                    type: 'rect', x0: 0, x1: 33.3, y0: 33.3, y1: 66.6,
                    fillcolor: 'rgba(244, 67, 54, 0.05)', line: { width: 0 }
                },
                {
                    type: 'rect', x0: 33.3, x1: 66.6, y0: 33.3, y1: 66.6,
                    fillcolor: 'rgba(255, 235, 59, 0.05)', line: { width: 0 }
                }
            ],
            annotations: [
                {
                    x: 83.3, y: 16.65, text: 'Alto LONG', showarrow: false,
                    font: { color: '#4CAF50', size: 12 }
                },
                {
                    x: 50, y: 16.65, text: 'Medio LONG', showarrow: false,
                    font: { color: '#4CAF50', size: 12 }
                },
                {
                    x: 16.65, y: 83.3, text: 'Alto SHORT', showarrow: false,
                    font: { color: '#F44336', size: 12 }
                },
                {
                    x: 16.65, y: 50, text: 'Medio SHORT', showarrow: false,
                    font: { color: '#F44336', size: 12 }
                },
                {
                    x: 50, y: 50, text: 'Neutral', showarrow: false,
                    font: { color: '#A0AEC0', size: 12 }
                }
            ]
        };
        
        Plotly.newPlot('scatterPlot', traces, layout);
        
        // Filtro por volumen
        document.getElementById('volume-filter').addEventListener('change', function() {
            const filter = this.value;
            const visibleTraces = [];
            
            traces.forEach((trace, index) => {
                if (filter === 'all' || trace.name === filter || trace.name === 'Bitcoin') {
                    visibleTraces.push(index);
                }
            });
            
            Plotly.restyle('scatterPlot', 'visible', 
                traces.map((_, i) => visibleTraces.includes(i))
            );
        });
        
        // Auto-refresh cada 5 minutos
        setTimeout(() => {
            location.reload();
        }, 300000);
        
        // Manejo del formulario
        document.getElementById('filters-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const params = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/update_params', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(params)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showNotification('Parámetros actualizados. Recargando...', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    showNotification('Error: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Error de conexión', 'error');
            }
        });
        
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
</body>
</html>
