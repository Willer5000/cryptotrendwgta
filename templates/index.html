<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wgta Crypto Trading Signals</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .signal-card { transition: transform 0.3s; }
        .signal-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .long-bg { background-color: #e8f5e9; border-left: 4px solid #4CAF50; }
        .short-bg { background-color: #ffebee; border-left: 4px solid #F44336; }
        .volume-extreme { color: #b71c1c; font-weight: bold; }
        .volume-high { color: #d32f2f; font-weight: bold; }
        .volume-medium { color: #f57c00; }
        .chart-container { position: relative; height: 300px; }
        .manual-section { background: #f8f9fa; border-radius: 10px; padding: 20px; }
        .crypto-table th { background-color: #f1f1f1; position: sticky; top: 0; }
        .info-badge { font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
            <div>
                <h1 class="mb-1">wgta Crypto Trading Signals</h1>
                <p class="text-muted mb-0">Sistema profesional de análisis técnico para criptomonedas</p>
                <small class="text-muted">Autor: wgta | <a href="https://github.com/Willer5000" target="_blank">GitHub</a></small>
            </div>
            <div class="text-end">
                <div class="bg-light p-2 rounded">
                    <small class="d-block">Actualizado: {{ now.strftime('%Y-%m-%d %H:%M') }}</small>
                    <small class="d-block">Cryptos analizadas: {{ total_cryptos }}</small>
                    <small class="d-block">Tiempo proceso: {{ processing_time }}s</small>
                </div>
            </div>
        </header>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h5 mb-0">Panel de Control</h2>
                    </div>
                    <div class="card-body">
                        <form method="POST" class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label">Temporalidad</label>
                                <select name="timeframe" class="form-select">
                                    {% for tf in ['30m','1h','2h','4h','1d','1w'] %}
                                    <option value="{{ tf }}" {% if params.timeframe==tf %}selected{% endif %}>
                                        {{ tf }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label">EMA Rápida</label>
                                <input type="number" name="ema_fast" value="{{ params.ema_fast }}" class="form-control">
                                <small class="text-muted">(Default: 9)</small>
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label">EMA Lenta</label>
                                <input type="number" name="ema_slow" value="{{ params.ema_slow }}" class="form-control">
                                <small class="text-muted">(Default: 20)</small>
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label">ADX Período</label>
                                <input type="number" name="adx_period" value="{{ params.adx_period }}" class="form-control">
                                <small class="text-muted">(Default: 14)</small>
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label">ADX Nivel</label>
                                <input type="number" name="adx_level" value="{{ params.adx_level }}" class="form-control">
                                <small class="text-muted">(Min: 25)</small>
                            </div>
                            
                            <div class="col-md-2">
                                <label class="form-label">RSI Período</label>
                                <input type="number" name="rsi_period" value="{{ params.rsi_period }}" class="form-control">
                                <small class="text-muted">(Default: 14)</small>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">S/R Ventana</label>
                                <input type="number" name="sr_window" value="{{ params.sr_window }}" class="form-control">
                                <small class="text-muted">(Default: 50)</small>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Divergencia Lookback</label>
                                <input type="number" name="divergence_lookback" value="{{ params.divergence_lookback }}" class="form-control">
                                <small class="text-muted">(Default: 20)</small>
                            </div>
                            
                            <div class="col-md-12 mt-2">
                                <button type="submit" class="btn btn-primary w-100 py-2">
                                    <i class="bi bi-arrow-repeat"></i> Actualizar Análisis (Top 150 Cryptos)
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h2 class="h5 mb-0">Señales LONG ({{ long_signals|length }})</h2>
                        <span class="badge bg-light text-success">Tendencia Alcista</span>
                    </div>
                    <div class="card-body">
                        {% if long_signals %}
                        <div class="table-responsive">
                            <table class="table table-hover crypto-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Cripto</th>
                                        <th>Entrada</th>
                                        <th>SL</th>
                                        <th>TP1</th>
                                        <th>TP2</th>
                                        <th>Vol</th>
                                        <th>ADX</th>
                                        <th>RSI</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for signal in long_signals %}
                                    <tr class="long-bg signal-card" data-bs-toggle="collapse" href="#detailLong{{ loop.index }}">
                                        <td>{{ loop.index }}</td>
                                        <td><strong>{{ signal.symbol }}</strong></td>
                                        <td>{{ signal.entry }}</td>
                                        <td class="text-danger">{{ signal.sl }}</td>
                                        <td class="text-success">{{ signal.tp1 }}</td>
                                        <td class="text-success">{{ signal.tp2 }}</td>
                                        <td class="volume-high">{{ signal.volume }}</td>
                                        <td>{{ signal.adx }}</td>
                                        <td>{{ signal.rsi }}</td>
                                    </tr>
                                    <tr class="collapse" id="detailLong{{ loop.index }}">
                                        <td colspan="9">
                                            <div class="p-3 bg-light rounded">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h5>Detalles de la operación</h5>
                                                        <ul>
                                                            <li><strong>Take Profit 3:</strong> {{ signal.tp3 }}</li>
                                                            <li><strong>Divergencia:</strong> {{ 'Sí' if signal.divergence else 'No' }}</li>
                                                            <li><strong>Ratio Riesgo/Beneficio:</strong> 1:3</li>
                                                            <li><strong>Volumen:</strong> <span class="volume-high">{{ signal.volume }}</span></li>
                                                        </ul>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h5>Gráfico de análisis</h5>
                                                        <img src="data:image/png;base64,{{ signal.chart }}" class="img-fluid" alt="{{ signal.symbol }} Chart">
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-warning text-center">
                            <i class="bi bi-exclamation-triangle"></i> No se encontraron señales LONG en este momento
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                        <h2 class="h5 mb-0">Señales SHORT ({{ short_signals|length }})</h2>
                        <span class="badge bg-light text-danger">Tendencia Bajista</span>
                    </div>
                    <div class="card-body">
                        {% if short_signals %}
                        <div class="table-responsive">
                            <table class="table table-hover crypto-table">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Cripto</th>
                                        <th>Entrada</th>
                                        <th>SL</th>
                                        <th>TP1</th>
                                        <th>TP2</th>
                                        <th>Vol</th>
                                        <th>ADX</th>
                                        <th>RSI</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for signal in short_signals %}
                                    <tr class="short-bg signal-card" data-bs-toggle="collapse" href="#detailShort{{ loop.index }}">
                                        <td>{{ loop.index }}</td>
                                        <td><strong>{{ signal.symbol }}</strong></td>
                                        <td>{{ signal.entry }}</td>
                                        <td class="text-danger">{{ signal.sl }}</td>
                                        <td class="text-success">{{ signal.tp1 }}</td>
                                        <td class="text-success">{{ signal.tp2 }}</td>
                                        <td class="volume-high">{{ signal.volume }}</td>
                                        <td>{{ signal.adx }}</td>
                                        <td>{{ signal.rsi }}</td>
                                    </tr>
                                    <tr class="collapse" id="detailShort{{ loop.index }}">
                                        <td colspan="9">
                                            <div class="p-3 bg-light rounded">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h5>Detalles de la operación</h5>
                                                        <ul>
                                                            <li><strong>Take Profit 3:</strong> {{ signal.tp3 }}</li>
                                                            <li><strong>Divergencia:</strong> {{ 'Sí' if signal.divergence else 'No' }}</li>
                                                            <li><strong>Ratio Riesgo/Beneficio:</strong> 1:3</li>
                                                            <li><strong>Volumen:</strong> <span class="volume-high">{{ signal.volume }}</span></li>
                                                        </ul>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h5>Gráfico de análisis</h5>
                                                        <img src="data:image/png;base64,{{ signal.chart }}" class="img-fluid" alt="{{ signal.symbol }} Chart">
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-warning text-center">
                            <i class="bi bi-exclamation-triangle"></i> No se encontraron señales SHORT en este momento
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h2 class="h5 mb-0">Resumen del Mercado</h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="marketChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-warning text-white">
                        <h2 class="h5 mb-0">Fuerza de Tendencia</h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="trendStrengthChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h2 class="h5 mb-0">Indicadores Promedio</h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="indicatorsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card manual-section">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h5 mb-0">Manual Técnico Completo</h2>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h3><i class="bi bi-graph-up"></i> Estrategia de Trading Profesional</h3>
                                <p>Este sistema detecta oportunidades basadas en el análisis técnico institucional:</p>
                                <ul>
                                    <li><strong>EMAs (9/20):</strong> Cruce para determinar tendencia primaria</li>
                                    <li><strong>ADX (>25):</strong> Confirmación de fuerza tendencial</li>
                                    <li><strong>RSI (30-70):</strong> Detección de sobrecompra/sobreventa</li>
                                    <li><strong>Soportes/Resistencias:</strong> Zonas clave para entradas y stops</li>
                                    <li><strong>Divergencias:</strong> Alertas tempranas de reversión</li>
                                    <li><strong>Volumen (2x+):</strong> Confirmación de movimientos</li>
                                </ul>
                                
                                <h4>Patrones Clave Detectados</h4>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <span class="badge bg-info">Triángulos Ascendentes/Descendentes</span>
                                    <span class="badge bg-info">Canales de Precio</span>
                                    <span class="badge bg-info">Doble Techo/Suelo</span>
                                    <span class="badge bg-info">Banderas Alcistas/Bajistas</span>
                                    <span class="badge bg-info">Cuñas de Reversión</span>
                                </div>
                                
                                <h4>Gestón de Riesgo</h4>
                                <ol>
                                    <li>Stop Loss siempre a 1.5-2% del capital</li>
                                    <li>Take Profit escalonado (TP1: 50%, TP2: 30%, TP3: 20%)</li>
                                    <li>Ratio mínimo riesgo/beneficio: 1:3</li>
                                    <li>Diversificación máxima 5% por operación</li>
                                </ol>
                            </div>
                            
                            <div class="col-md-6">
                                <h3><i class="bi bi-lightbulb"></i> Recomendaciones Prácticas</h3>
                                <div class="alert alert-success">
                                    <strong>Estrategia LONG:</strong>
                                    <ul>
                                        <li>Operar con volumen mínimo "Alto"</li>
                                        <li>Confirmar con ADX > 25 y RSI < 70</li>
                                        <li>Buscar divergencias alcistas en soportes clave</li>
                                        <li>TP1 en primera resistencia significativa</li>
                                    </ul>
                                </div>
                                
                                <div class="alert alert-danger">
                                    <strong>Estrategia SHORT:</strong>
                                    <ul>
                                        <li>Volumen confirmatorio imprescindible</li>
                                        <li>ADX > 30 para tendencias fuertes</li>
                                        <li>Divergencias bajistas en zonas de resistencia</li>
                                        <li>Operar con temporalidad mínima de 4h</li>
                                    </ul>
                                </div>
                                
                                <h4>Contexto de Mercado</h4>
                                <p>Según los últimos análisis:</p>
                                <ul>
                                    <li>Bitcoin domina con el 64.9% del mercado :cite[10]</li>
                                    <li>Altcoins muestran fuerza (49% superan a BTC) :cite[8]</li>
                                    <li>Volumen institucional en altcoins +45% :cite[8]</li>
                                    <li>Ethereum lidera crecimiento (+55% mensual) :cite[8]</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="alert alert-primary mt-3">
                            <strong>Nota profesional:</strong> Las criptomonedas son activos de alta volatilidad.
                            Este sistema es una herramienta de apoyo que debe combinarse con análisis fundamental
                            y gestión adecuada de riesgo. Los rendimientos pasados no garantizan resultados futuros.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Gráfico de resumen
        const marketCtx = document.getElementById('marketChart').getContext('2d');
        const marketChart = new Chart(marketCtx, {
            type: 'doughnut',
            data: {
                labels: ['LONG', 'SHORT', 'Neutral'],
                datasets: [{
                    data: [
                        {{ long_signals|length }}, 
                        {{ short_signals|length }}, 
                        {{ total_cryptos - long_signals|length - short_signals|length }}
                    ],
                    backgroundColor: [
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(231, 76, 60, 0.7)',
                        'rgba(149, 165, 166, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' },
                    title: {
                        display: true,
                        text: 'Distribución de Señales ({{ total_cryptos }} Cryptos)'
                    }
                }
            }
        });
        
        // Gráfico de fuerza de tendencia
        const trendCtx = document.getElementById('trendStrengthChart').getContext('2d');
        const trendChart = new Chart(trendCtx, {
            type: 'bar',
            data: {
                labels: ['LONG', 'SHORT'],
                datasets: [{
                    label: 'ADX Promedio',
                    data: [{{ avg_adx_long }}, {{ avg_adx_short }}],
                    backgroundColor: [
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(231, 76, 60, 0.7)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'ADX'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Fuerza de Tendencia'
                    }
                }
            }
        });
        
        // Gráfico de indicadores
        const indCtx = document.getElementById('indicatorsChart').getContext('2d');
        const indicatorsChart = new Chart(indCtx, {
            type: 'radar',
            data: {
                labels: ['ADX LONG', 'ADX SHORT', 'RSI LONG', 'RSI SHORT'],
                datasets: [{
                    label: 'Indicadores Promedio',
                    data: [
                        {{ avg_adx_long }},
                        {{ avg_adx_short }},
                        {{ avg_rsi_long }},
                        {{ avg_rsi_short }}
                    ],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    r: {
                        angleLines: {
                            display: true
                        },
                        suggestedMin: 0,
                        suggestedMax: 70
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Indicadores Promedio'
                    }
                }
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
